select distinct
gl.MERCHANT_CODE,
su.email,
ac.LEGAL_TYPE_C AS LEGAL_TYPE,
kas.NAME AS "ACTION NAME",
kl.comment,
kl.action_time::date as action_time,
S.TEAM_LEAD,
s.SUPERVISOR
from SUMUP_DWH_PROD.SRC_PAYMENT.KYC_LOGS kl
left join SUMUP_DWH_PROD.SRC_PAYMENT.SUPERUSERS su ON su.id = kl.operator_id
left join SUMUP_DWH_PROD.ANALYST_OPERATIONS.OPS_SCHEDULE s on s.agent = su.email and s.date = kl.action_time::date
left join SUMUP_DWH_PROD.SRC_PAYMENT.KYC_ACTION_STATUSES kas on kas.id = kl.kyc_action_status_id
LEFT JOIN SUMUP_DWH_PROD.SRC_PAYMENT.KYC_ACTIONS ka ON ka.id = kl.kyc_action_id
LEFT JOIN SUMUP_DWH_PROD.SRC_SALESFORCE.ACCOUNT ac ON kl.merchant_id = ac.merchant_id_upon_creation_c
LEFT JOIN SUMUP_DWH_PROD.SRC_SALESFORCE.CONTACT sc ON sc.ACCOUNT_ID = ac.ID
LEFT JOIN global_analyst_prod.mart_growth.verification_merchant_verification_status gl ON sc.backend_merchant_id_c = gl.merchant_id 
left join SUMUP_DWH_PROD.SRC_PAYMENT.USERS u on gl.merchant_id = u.MERCHANT_ID
left join SUMUP_DWH_PROD.SRC_PAYMENT.PERSONAL_DETAILS pd ON u.PERSONAL_DETAIL_ID = pd.ID
LEFT JOIN SUMUP_DWH_PROD.SRC_PAYMENT.BUSINESS_DETAILS bd ON gl.merchant_id = bd.MERCHANT_ID
where 1=1
AND GL.COUNTRY_NAME = 'brazil'
AND kas.id IN ('44','45')
AND kl.ACTION_TIME::date >= '2025-10-01'--- ajuste de período a ser monitorado ----
--AND kl.ACTION_TIME::date >= '2025-08-06'--- ajuste de período a ser monitorado ----
AND kl.COMMENT ilike '%#KYCEDDBR%'
AND (kl.COMMENT NOT ilike '%#KYCEDDBR - Analise de KYC%' AND kl.COMMENT NOT ilike '%falso positivo%')
--AND su.email in ('anna.sala@sumup.com')
QUALIFY ROW_NUMBER() OVER (PARTITION BY kl.MERCHANT_ID ORDER BY kl.action_time desc) = 1
;
